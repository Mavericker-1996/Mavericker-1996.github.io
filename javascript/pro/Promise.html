<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise | Mavericker&#39;s Blog</title>
    <meta name="description" content="赵佐骑的个人博客，前端">
    <link rel="icon" href="/fav.ico">
  <script type="text/javascript">var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?5a982c6c5e0d0d786523e60a7a647022";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script>
    
    <link rel="preload" href="/assets/css/0.styles.76307617.css" as="style"><link rel="preload" href="/assets/js/app.813c17b6.js" as="script"><link rel="preload" href="/assets/js/30.9b752411.js" as="script"><link rel="prefetch" href="/assets/js/12.e71bc87f.js"><link rel="prefetch" href="/assets/js/2.b8909fec.js"><link rel="prefetch" href="/assets/js/3.8d04fbbf.js"><link rel="prefetch" href="/assets/js/4.76cb4dbf.js"><link rel="prefetch" href="/assets/js/5.82846fcf.js"><link rel="prefetch" href="/assets/js/6.d026f6bc.js"><link rel="prefetch" href="/assets/js/7.614c0c26.js"><link rel="prefetch" href="/assets/js/8.91f64669.js"><link rel="prefetch" href="/assets/js/9.bd03efb0.js"><link rel="prefetch" href="/assets/js/10.b72941af.js"><link rel="prefetch" href="/assets/js/11.55c4af94.js"><link rel="prefetch" href="/assets/js/13.1b4e26a1.js"><link rel="prefetch" href="/assets/js/14.6ce88fa2.js"><link rel="prefetch" href="/assets/js/15.53815097.js"><link rel="prefetch" href="/assets/js/16.3d021803.js"><link rel="prefetch" href="/assets/js/17.ac6b335f.js"><link rel="prefetch" href="/assets/js/18.539a72e1.js"><link rel="prefetch" href="/assets/js/19.46c5d299.js"><link rel="prefetch" href="/assets/js/20.bbe25a47.js"><link rel="prefetch" href="/assets/js/21.b57b41b7.js"><link rel="prefetch" href="/assets/js/22.24104113.js"><link rel="prefetch" href="/assets/js/23.a1aadb14.js"><link rel="prefetch" href="/assets/js/24.7f66a479.js"><link rel="prefetch" href="/assets/js/25.0d998f42.js"><link rel="prefetch" href="/assets/js/26.0448ab80.js"><link rel="prefetch" href="/assets/js/27.20ca2d83.js"><link rel="prefetch" href="/assets/js/28.56900e6e.js"><link rel="prefetch" href="/assets/js/29.580fb71b.js"><link rel="prefetch" href="/assets/js/31.71a3e01f.js"><link rel="prefetch" href="/assets/js/32.633b1158.js"><link rel="prefetch" href="/assets/js/33.f80c8c22.js"><link rel="prefetch" href="/assets/js/34.f4d2a30d.js"><link rel="prefetch" href="/assets/js/35.3ad15739.js"><link rel="prefetch" href="/assets/js/36.324804a5.js"><link rel="prefetch" href="/assets/js/37.59925d68.js"><link rel="prefetch" href="/assets/js/38.e6f8d299.js"><link rel="prefetch" href="/assets/js/39.46060081.js"><link rel="prefetch" href="/assets/js/40.92805123.js"><link rel="prefetch" href="/assets/js/41.8516a958.js"><link rel="prefetch" href="/assets/js/42.985e6416.js"><link rel="prefetch" href="/assets/js/43.770aaa1a.js"><link rel="prefetch" href="/assets/js/44.56039045.js"><link rel="prefetch" href="/assets/js/45.07330c76.js"><link rel="prefetch" href="/assets/js/46.6d200ff4.js"><link rel="prefetch" href="/assets/js/47.2ecec06c.js"><link rel="prefetch" href="/assets/js/48.2a749d70.js"><link rel="prefetch" href="/assets/js/49.5defabfe.js"><link rel="prefetch" href="/assets/js/50.391c2931.js"><link rel="prefetch" href="/assets/js/51.823ddd3e.js"><link rel="prefetch" href="/assets/js/52.272e9779.js"><link rel="prefetch" href="/assets/js/53.dd41478f.js"><link rel="prefetch" href="/assets/js/54.bdd75c33.js"><link rel="prefetch" href="/assets/js/55.6713f330.js"><link rel="prefetch" href="/assets/js/56.19a9b3e2.js"><link rel="prefetch" href="/assets/js/57.30130f5c.js"><link rel="prefetch" href="/assets/js/58.63ce249b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76307617.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mavericker's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/network/" class="nav-link">网络</a></div><div class="nav-item"><a href="/css/" class="nav-link">CSS</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javascript/basic/" class="nav-link">JavaScript基础</a></li><li class="dropdown-item"><!----> <a href="/javascript/pro/" class="nav-link router-link-active">JavaScript专题</a></li></ul></div></div><div class="nav-item"><a href="/vue/" class="nav-link">Vue</a></div><div class="nav-item"><a href="/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/resume/" class="nav-link">个人简历</a></div><div class="nav-item"><a href="https://github.com/Mavericker-1996/Mavericker-1996.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/network/" class="nav-link">网络</a></div><div class="nav-item"><a href="/css/" class="nav-link">CSS</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javascript/basic/" class="nav-link">JavaScript基础</a></li><li class="dropdown-item"><!----> <a href="/javascript/pro/" class="nav-link router-link-active">JavaScript专题</a></li></ul></div></div><div class="nav-item"><a href="/vue/" class="nav-link">Vue</a></div><div class="nav-item"><a href="/react/" class="nav-link">React</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/resume/" class="nav-link">个人简历</a></div><div class="nav-item"><a href="https://github.com/Mavericker-1996/Mavericker-1996.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/javascript/pro/" class="sidebar-link">JavaScript专题</a></li><li><a href="/javascript/pro/防抖.html" class="sidebar-link">防抖与节流</a></li><li><a href="/javascript/pro/柯里化.html" class="sidebar-link">柯里化</a></li><li><a href="/javascript/pro/Promise.html" class="active sidebar-link">Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#模拟实现promise-all" class="sidebar-link">模拟实现Promise.all()</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#函数特点" class="sidebar-link">函数特点</a></li><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#实现思路" class="sidebar-link">实现思路</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#一道有趣的测试题" class="sidebar-link">一道有趣的测试题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#题目描述" class="sidebar-link">题目描述</a></li><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#改进验证" class="sidebar-link">改进验证</a></li></ul></li><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#模拟实现promise" class="sidebar-link">模拟实现Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/javascript/pro/Promise.html#代码实现" class="sidebar-link">代码实现</a></li></ul></li></ul></li><li><a href="/javascript/pro/ScriptOJ.html" class="sidebar-link">ScriptOJ</a></li></ul> </div> <div class="page"> <div class="content"><h1 id="promise"><a href="#promise" aria-hidden="true" class="header-anchor">#</a> Promise</h1> <h2 id="模拟实现promise-all"><a href="#模拟实现promise-all" aria-hidden="true" class="header-anchor">#</a> 模拟实现Promise.all()</h2> <p>关于<code>Promise.all()</code>的用法，可以参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise/all" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="函数特点"><a href="#函数特点" aria-hidden="true" class="header-anchor">#</a> 函数特点</h3> <p>在这里总结一下<code>Promise.all()</code>的特点：</p> <ol><li>接收一个 <code>Promise</code> 实例的数组或具有 <code>Iterator</code> 接口的对象</li> <li>如果元素不是 <code>Promise</code> 对象，则使用 <code>Promise.resolve</code> 转成 <code>Promise</code> 对象</li> <li>数组中多个 promise 是同时开始、并行执行的，而不是顺序执行</li> <li>如果全部成功，状态变为 <code>resolved</code>，返回值将将按传入的数组顺序组成一个数组传给回调</li> <li>只要有一个失败，状态就变为 <code>rejected</code>，返回值将直接传递给回调</li> <li><code>all()</code> 的返回值也是新的 <code>Promise</code> 对象</li></ol> <h3 id="实现思路"><a href="#实现思路" aria-hidden="true" class="header-anchor">#</a> 实现思路</h3> <p>根据函数特点，我们可以遍历数组，执行每一个元素，将每一个<code>Promise</code>resolve的结果按照索引存入一个结果数组中，并判断如果全部遍历完的话再resolve这个结果数组。中途如果有一个失败，就直接reject。代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">,</span> <span class="token string">&quot;first&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;third&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// Promise.all([p1, p2, p3]).then(function(values) { </span>
<span class="token comment">// 	console.log(values); </span>
<span class="token comment">// }).catch(reason=&gt;console.log(reason));</span>

<span class="token keyword">var</span> <span class="token function-variable function">all</span> <span class="token operator">=</span> arr <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//结果数组</span>
	<span class="token keyword">var</span> tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//判断是否遍历完</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
		arr<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
			Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val<span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token comment">//当传入的不是Promise对象时要包裹成Promise对象</span>
				res<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">;</span>
				tmp<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>tmp <span class="token operator">==</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//如果遍历完再resolve</span>
					<span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>val<span class="token operator">=&gt;</span><span class="token function">reject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//捕获到错误直接返回reject状态</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">,</span>p3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>val<span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//[ 1, 'first', 'second', 'third' ]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="一道有趣的测试题"><a href="#一道有趣的测试题" aria-hidden="true" class="header-anchor">#</a> 一道有趣的测试题</h2> <p>（美团一面）</p> <h3 id="题目描述"><a href="#题目描述" aria-hidden="true" class="header-anchor">#</a> 题目描述</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//以下代码会输出什么</span>
Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//b c</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>第一个输出b不难理解，至于第二个为什么输出c，我们知道，<code>then()</code>方法返回的是一个<strong>新的Promise实例</strong>（不是原来那个Promise实例）。</p> <p>默认是将<strong>返回值将作为参数</strong>传入这个新Promise的<code>resolve</code>函数（即新的Promise会由pending =&gt; fufillment状态,<strong>通俗的说就是新的Promise变成Promise.resolve(value) 了</strong>） 。当然如果什么都不返回的话，传入的也会是空值，即<code>Promise.resolve()</code>。</p> <p>如果返回值是一个reject状态的Promise，那么then返回的Promise也会成为拒绝状态，并且将那个Promise的拒绝状态的回调函数的参数值作为该被返回的Promise的拒绝状态回调函数的参数值。</p> <p>所以由于第一个<code>then()</code>方法中第二项没有返回值，所以就会返回<code>Promise.resolve()</code>传入下一个<code>then()</code>方法中，自然就会输出c了。</p> <h3 id="改进验证"><a href="#改进验证" aria-hidden="true" class="header-anchor">#</a> 改进验证</h3> <p>接下来我们可以对原题进行一些改变，来加深理解。</p> <p>首先我们在第一个<code>then()</code>方法中第二个函数参数中返回一个值，再在第二个<code>then()</code>方法的第一个函数参数中进行输出，可以输出了对应值1，这与我们之前的预期一致。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//以下代码会输出什么</span>
Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//b 1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接着我们在第一个<code>then()</code>方法中第二个函数参数中返回一个reject状态的Promise对象，并传入一个值，，再在第二个<code>then()</code>方法的第二个函数参数中进行输出，可以输出了对应值2，这与我们之前的预期一致。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">//b 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="模拟实现promise"><a href="#模拟实现promise" aria-hidden="true" class="header-anchor">#</a> 模拟实现Promise</h2> <p>参考文章</p> <ol><li>https://www.cnblogs.com/huansky/p/6064402.html</li> <li>https://www.cnblogs.com/wwhhq/p/8185839.html</li></ol> <h3 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h3> <p>十一放假终于有空静下心来实现一下早就想实现的Promise了，首先我从《你不知道的JavaScript》中温习了一下同步异步，并行，回调函数几个概念，感觉又有了一些比较新的，更清晰的认识。</p> <p>首先关于异步，引用书中的一句话：</p> <blockquote><p>程序中现在运行的部分和将来运行的部分之间的关系就是异步编程的核心。</p></blockquote> <p>也就是说，程序中<strong>将来</strong>执行的部分并不一定在<strong>现在</strong>运行的部分执行完之后就立即执行。换句话说，<strong>现在</strong>无法完成的任务将会异步完成，因此并不会出现人们本能地认为会出现的或希望实现的<strong>阻塞</strong>行为。</p> <p>所以我们通过<strong>回调函数</strong>加上一些<strong>判断条件</strong>来实现异步。不过这样可能会引发<strong>回调地狱</strong>的问题。</p> <p>接下来再谈谈并行与异步，这两个术语常常被混为一谈，但实际上他们的意义完全不同。记住，<strong>异步是关于现在和将来的时间间隙</strong>，<strong>而并行是关于能够同时发生的事情</strong>。由于JavaScript单线程的特性，它使得每一个代码段具有<strong>完整运行</strong>的特性。如果是多线程的话，每一个代码段可能<strong>交替运行</strong>。</p> <h3 id="代码实现"><a href="#代码实现" aria-hidden="true" class="header-anchor">#</a> 代码实现</h3> <p>首先我们想一下一个Promise对象内部都需要哪些东西：</p> <ol><li><code>value</code>：当前Promise对象中保持的值，比方说我们执行<code>resolve(2)</code>的时候，就把2保存到<code>value</code>中，接下来的<code>then()</code>方法会用到。</li> <li><code>status</code>：正是因为这个status状态的引入，才使我们从回调地狱中解放出来，我们不必要一层套一层，而是结合状态值和then链进行异步操作。我们知道状态有三种：<code>pending</code>，<code>resolved</code>，<code>reject</code>。</li> <li><code>onResolvedCallback</code>，<code>onRejectedCallback</code>：用于保存 then 中的回调，只有当 promise状态为 pending 时才会缓存。</li> <li><code>resolve</code>函数，<code>reject</code>函数：我们传入Promise对象的是一个带有<code>resolve</code>和<code>reject</code>参数的一个函数executor，所以当我们在里面调用这两个参数的时候，我们里面要有这两个函数，并且我们传入的函数要立即执行的。</li> <li>所以我们每new一个新的Promise对象的时候，里面都会有以上参数和函数，需要注意<strong>每一个Promise对象的参数和函数都是独立的，不一样的，属于他们自己本身的</strong>，所以接下来也涉及到了闭包的应用，这个点卡了我好久，所以要在此声明一下。</li> <li>关于then方法，由于是每个实例公用的，所以应该写到原型链上。</li></ol> <p>所以构造函数myPromise代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">myPromise</span><span class="token punctuation">(</span>executor<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// Promise的值</span>
	self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span><span class="token punctuation">;</span> <span class="token comment">// Promise当前的状态</span>
	<span class="token comment">// 用于保存 then 中的回调，只有当 promise</span>
	<span class="token comment">// 状态为 pending 时才会缓存，并且每个实例至多缓存一个</span>
	self<span class="token punctuation">.</span>onResolvedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	self<span class="token punctuation">.</span>onRejectedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">//resolve函数功能：1.改变状态 2.更改value属性值 3.调用回调函数</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'resolved'</span><span class="token punctuation">;</span>
			self<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
			self<span class="token punctuation">.</span>onResolvedCallback<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback<span class="token operator">=&gt;</span><span class="token function">callback</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>		
	<span class="token punctuation">}</span>

	<span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//功能同上</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span><span class="token punctuation">;</span>
			self<span class="token punctuation">.</span>value <span class="token operator">=</span> reason<span class="token punctuation">;</span>
			self<span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>callback<span class="token operator">=&gt;</span><span class="token function">callback</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>		
	<span class="token punctuation">}</span>

	<span class="token keyword">try</span><span class="token punctuation">{</span><span class="token comment">// 考虑到执行executor的过程中有可能出错，所以我们用try/catch块给包起来，并且在出错后以catch到的值reject掉这个Promise</span>
		<span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>then方法代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>myPromise<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>onResolved<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> promise2<span class="token punctuation">;</span>
	onResolved <span class="token operator">=</span> <span class="token keyword">typeof</span> onResolved <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> onResolved <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> value<span class="token punctuation">}</span><span class="token punctuation">;</span>
	onRejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> onRejected <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> reason<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'resolved'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolved then'</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 异步执行onResolved</span>
			<span class="token keyword">try</span><span class="token punctuation">{</span> <span class="token comment">// 因为考虑到有可能throw，所以我们将其包在try/catch块里</span>
				<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onResolved</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果状态为onFullfilled,则调用相应回调函数</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">myPromise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token comment">// 如果onResolved的返回值是一个myPromise对象，直接取它的结果做为promise2的结果</span>
					<span class="token comment">// 具体操作为将resolve,reject作为它回调函数调用then函数，有点递归的思想。</span>
					<span class="token comment">// 由于then()方法return的是一个新对象，根据new操作符的特点，如果构造函数中返回了一个对象，则new也返回这个对象。</span>
					x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span><span class="token comment">//否则，以它的返回值做为promise2的结果</span>
					<span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>				
		<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span> 

		<span class="token punctuation">}</span><span class="token punctuation">)</span> 	
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token keyword">try</span><span class="token punctuation">{</span>
					<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">myPromise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
						x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
						<span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>				
				<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
					<span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>

		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  		<span class="token comment">// 如果当前的Promise还处于pending状态，我们并不能确定调用onResolved还是onRejected，</span>
  		<span class="token comment">// 只能等到Promise的状态确定后，才能确实如何处理。</span>
  		<span class="token comment">// 所以我们需要把我们的两种情况的处理逻辑做为callback放入promise1(此处即this/self)的回调数组里</span>
  		<span class="token comment">// 逻辑本身跟第一个if块内的几乎一致，此处不做过多解释</span>
  		<span class="token keyword">return</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
  			self<span class="token punctuation">.</span>onResolvedCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">//注意是push到上一个的myPromise对象里面</span>
  				<span class="token keyword">try</span><span class="token punctuation">{</span>
  					<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onResolved</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  					<span class="token keyword">if</span><span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">myPromise</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  						x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span>
  					<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  						<span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用到了闭包，resolve的是new myPromise(function(resolve,reject)中的resolve,所以就传到下一个了。</span>
  					<span class="token punctuation">}</span>
  				<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
  					<span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  				<span class="token punctuation">}</span>
  			<span class="token punctuation">}</span><span class="token punctuation">)</span>

  			self<span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  				<span class="token keyword">try</span> <span class="token punctuation">{</span>
  					<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
  					<span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  						x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  					<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
  						<span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  					<span class="token punctuation">}</span>
  				<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  					<span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
  				<span class="token punctuation">}</span>
  			<span class="token punctuation">}</span><span class="token punctuation">)</span>
  		<span class="token punctuation">}</span><span class="token punctuation">)</span>		
  	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br></div></div><p>这里我们用一个例子来分析一下流程。测试代码如下：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>  <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">myPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'before resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  		<span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>v<span class="token operator">=&gt;</span>v<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>v<span class="token operator">=&gt;</span>v<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>v<span class="token operator">=&gt;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//正常3s后打印6</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>流程如下：</p> <ol><li>首先我们创造了一个myPromise实例promise，里面包含一个延迟3s才会resolve的异步函数，这时就会以状态为pending执行then函数。</li> <li>then函数发现状态为pending，就会返回一个新的myPromise对象promise1 = new myPromise(function(<strong>resolve</strong>,reject){})，在这个新对象的传入的函数里面（new中的函数是会立即执行的）我们在promise实例的回调函数数组里面push了这样一个函数，它执行了这个then中的回调函数，并判断返回值是什么，如果是一个myPromise对象的话，就递归调用then获得它返回的结果，否则就返回<strong>resolve</strong>这个返回值，这里就涉及到了<strong>闭包的知识</strong>，当promise的resolve执行的时候，它会执行promise回调函数数组的函数，进而就执行了<strong>promise1的resolve函数</strong>。</li> <li>以此类推，promise1的then返回了一个新的myPromise对象promise2，传入promise1的回调数组中跟上面类似的东西，所以当<strong>promise1的resolve函数</strong>执行时，就会执行<strong>promise2的回调函数</strong>和<strong>promise2的resolve函数</strong>。依次这样传递下去...，这样也就形成了链式调用.</li></ol> <p>关于闭包的这个应用,其实在你不知道的JavaScript中早有提到, 可能当时还没有揣摩出真正的意义, 如今再看的时候, 豁然开朗:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">wait</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">wait</span><span class="token punctuation">(</span><span class="token string">'hello message'</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>将一个内部函数(名为timer)传递给setTimeout(...). timer具有涵盖wait(...) 作用域的闭包,因此还保有对变量message的引用.</p> <p>wait(...)执行1000ms后, 它的内部作用域并不会消失, timer函数依然保有wait(...)作用域的闭包.</p> <p>所以书中说:</p> <blockquote><p>只要使用了回调函数,实际上就是在使用闭包.</p></blockquote></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/javascript/pro/柯里化.html" class="prev">
          柯里化
        </a></span> <span class="next"><a href="/javascript/pro/ScriptOJ.html">
          ScriptOJ
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/30.9b752411.js" defer></script><script src="/assets/js/app.813c17b6.js" defer></script>
  </body>
</html>
